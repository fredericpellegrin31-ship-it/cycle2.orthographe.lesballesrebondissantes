<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Les balles d'accord</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.5.1/dist/confetti.browser.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Andika&family=Fredoka+One&display=swap');

        body {
            font-family: 'Andika', sans-serif;
            overflow: hidden;
            background: radial-gradient(circle, #f0fdf4 0%, #dcfce7 100%);
            margin: 0;
            touch-action: none;
            width: 100vw;
            height: 100vh;
        }

        #drawingCanvas { 
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            z-index: 10; 
            cursor: crosshair; 
            touch-action: none;
        }
        
        .ui-layer { 
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            z-index: 50; 
            pointer-events: none; 
        }

        .clickable { pointer-events: auto !important; cursor: pointer; }

        #robot-companion {
            position: fixed;
            font-size: 5rem;
            z-index: 20;
            pointer-events: none;
            transition: all 1s ease-in-out;
            animation: floating 3s ease-in-out infinite;
        }

        @keyframes floating {
            0%, 100% { transform: translateY(0px) rotate(0deg); }
            50% { transform: translateY(-20px) rotate(5deg); }
        }

        .robot-bubble {
            position: absolute;
            background: white;
            border: 4px solid #16a34a;
            border-radius: 20px;
            padding: 15px;
            width: 300px;
            top: -120px;
            right: 0px;
            box-shadow: 0 10px 15px rgba(0,0,0,0.1);
            font-size: 1.1rem;
            line-height: 1.4;
            color: #14532d;
        }
        .robot-bubble::after {
            content: '';
            position: absolute;
            bottom: -20px;
            right: 40px;
            border-width: 20px 20px 0 0;
            border-style: solid;
            border-color: #16a34a transparent transparent transparent;
        }

        .screen { display: none; height: 100%; flex-direction: column; align-items: center; justify-content: center; }
        .screen.active { display: flex; }

        .btn-main {
            background: #16a34a; color: white; padding: 15px 40px;
            border-radius: 20px; font-size: 1.5rem; font-weight: bold;
            box-shadow: 0 6px 0 #15803d; transition: all 0.1s;
            border: none;
        }
        .btn-main:active { transform: translateY(4px); box-shadow: none; }

        .sentence-container {
            position: absolute; top: 55%; left: 50%;
            transform: translate(-50%, -50%); width: 95%;
            display: flex; justify-content: center; align-items: baseline;
            gap: 0.8rem; flex-wrap: wrap; 
        }
        .word { font-size: 3.2rem; color: #164e63; position: relative; line-height: 2.2; user-select: none; }
        .level-3 .word { font-size: 2.1rem; } 

        .target-zone { position: relative; padding: 0 4px; border-radius: 8px; display: inline-block; }
        .suffix-zone { min-width: 0.8ch; display: inline-block; }
        
        .level-1 .suffix-zone:not(.revealed) { border-bottom: 3px dashed #94a3b8; color: transparent; }
        .level-2 .suffix-zone:not(.revealed), .level-3 .suffix-zone:not(.revealed) { color: transparent; border-bottom: none !important; }
        
        .revealed { color: #16a34a !important; font-weight: bold; border-bottom: none !important; animation: pop 0.4s ease-out; }
        .success-highlight { color: #16a34a !important; font-weight: bold; }

        @keyframes pop { 0% { transform: scale(0); } 80% { transform: scale(1.4); } 100% { transform: scale(1); } }

        .instruction-box {
            position: absolute; top: 30px; left: 50%; transform: translateX(-50%);
            background: rgba(255,255,255,0.95); padding: 15px 30px; border-radius: 50px;
            border: 5px solid #16a34a; box-shadow: 0 10px 20px rgba(0,0,0,0.1);
            font-weight: bold; font-size: 1.6rem; color: #14532d;
            text-align: center; width: 85%; max-width: 750px;
        }
    </style>
</head>
<body>

    <div id="robot-companion">
        ü§ñ
        <div id="home-bubble" class="robot-bubble">
            <strong>Au secours !</strong> Mes circuits ont br√ªl√© et j'ai oubli√© les marques du pluriel... Aide-moi √† les retrouver !
        </div>
    </div>
    
    <canvas id="drawingCanvas"></canvas>

    <div class="ui-layer">
        <div id="homeScreen" class="screen active">
            <h1 class="text-6xl font-bold text-green-900 mb-12 text-center" style="font-family: 'Fredoka One'; text-shadow: 2px 2px #fff; pointer-events: none;">Les balles d'accord</h1>
            
            <div class="flex flex-col gap-6">
                <button class="btn-main clickable bg-amber-500 shadow-amber-700 mb-4" onclick="showModal('lessonModal')">üìñ Voir la le√ßon</button>
                <div class="flex gap-4">
                    <button class="btn-main clickable" onclick="startGame(1)">Niveau 1</button>
                    <button class="btn-main clickable" onclick="startGame(2)">Niveau 2</button>
                    <button class="btn-main clickable" onclick="startGame(3)">Niveau 3</button>
                </div>
            </div>
        </div>

        <div id="gameScreen" class="screen">
            <div id="instruction" class="instruction-box">Entoure le d√©terminant</div>
            <div id="progressText" class="absolute top-24 md:top-6 right-10 text-2xl font-bold text-green-900"></div>
            <div id="gameSentence" class="sentence-container"></div>

            <div class="absolute bottom-10 left-10 flex gap-4">
                <button class="btn-main clickable bg-slate-600 shadow-slate-800" onclick="goHome()">üè† Menu</button>
            </div>

            <button id="nextBtn" class="btn-main clickable bg-blue-500 shadow-blue-700 absolute bottom-10 right-10 hidden" onclick="nextQuestion()">Phrase suivante ‚ûú</button>
        </div>
    </div>

    <div id="lessonModal" class="fixed top-0 left-0 w-full h-full bg-black/80 z-[2000] hidden items-center justify-center pointer-events-auto">
        <div class="bg-white p-8 rounded-3xl w-11/12 max-w-4xl flex flex-col items-center">
            <h2 class="text-3xl font-bold mb-4 text-green-900">Le√ßon : L'accord dans le groupe nominal</h2>
            <div class="w-full aspect-video mb-6 bg-black rounded-xl overflow-hidden">
                <iframe id="lessonIframe" width="100%" height="100%" frameborder="0" allowfullscreen></iframe>
            </div>
            <button class="btn-main clickable" onclick="closeModal('lessonModal')">J'ai compris !</button>
        </div>
    </div>

    <script>
        const invariables = [
            "dans", "vers", "sous", "sans", "mais", "puis", "alors", "toujours", 
            "plus", "bas", "souvent", "depuis", "tr√®s", "apr√®s", "pas", "longtemps", 
            "pr√®s", "fois", "souris", "brebis", "corps", "poids", "prix", "nez", "os", "le"
        ];

        const rawData = {
            1: ["Les chats", "Des chiens", "Mes stylos", "Tes livres", "Ses amis", "Nos jeux", "Vos mains", "Leurs v√©los", "Les pommes", "Des ballons"],
            2: ["Les petits chats", "Des grands chiens", "Mes nouveaux stylos", "Tes jolis livres", "Ses meilleurs amis", "Nos vieux jeux", "Vos blanches mains", "Leurs beaux v√©los"],
            3: [
                "Mes chers cousins lointains √©crivent des lettres depuis longtemps",
                "Des crayons cass√©s tra√Ænent sur la table de travail",
                "Les √©l√®ves curieux posent des questions int√©ressantes",
                "Des affiches color√©es d√©corent les murs de la classe",
                "Les fr√®res jumeaux regardent un dessin anim√© dr√¥le",
                "Des √©toiles brillantes illuminent le ciel nocturne",
                "Les parents attentifs √©coutent la ma√Ætresse de la classe",
                "Des chaussures mouill√©es s√®chent pr√®s de la porte d‚Äôentr√©e",
                "Des poissons color√©s nagent dans le grand aquarium",
                "Des nuages sombres cachent le soleil d'√©t√©",
                "Les petits oiseaux chantent des m√©lodies joyeuses",
                "Tes vieux habits dorment dans des cartons poussi√©reux",
                "Les courageux pompiers √©teignent des incendies dangereux",
                "Des g√¢teaux sucr√©s attendent sur les assiettes blanches",
                "Les grands arbres tremblent sous les vents violents",
                "Des lapins agiles sautent dans les champs verts",
                "Les petites filles cueillent des fleurs parfum√©es",
                "Tes nouveaux voisins portent des cartons lourds",
                "Les livres anciens racontent des histoires merveilleuses",
                "Des chiens sportifs courent apr√®s des balles rouges"
            ]
        };

        let currentLevel = 1, currentIdx = 0, levelQueue = [];
        let progress = { dets: [], bridges: [], suffixes: [] };
        let isDrawing = false, points = [];
        let screenMode = 'home';

        const robot = document.getElementById('robot-companion');
        const homeBubble = document.getElementById('home-bubble');
        const drawingCanvas = document.getElementById('drawingCanvas');
        const ctx = drawingCanvas.getContext('2d');

        function parseSentence(str) {
            const parts = str.split(' ');
            let lastDetIdx = -1;
            const parsed = parts.map((w, i) => {
                const clean = w.toLowerCase().replace(/[.,!?;:¬ª¬´"()‚Äô]/g, '');
                // D√©tection d√©terminant pluriel
                if(["les","des","mes","tes","ses","nos","vos","leurs","ces"].includes(clean)) {
                    lastDetIdx = i;
                    return {t:w, type:'det', id: i};
                }
                // D√©tection d'un mot accord√© (S ou X) li√© au dernier d√©terminant
                if(lastDetIdx !== -1 && (clean.endsWith('s') || clean.endsWith('x')) && !invariables.includes(clean)) {
                    return {t:w, root: w.slice(0,-1), s: w.slice(-1), type:'adj_noun', linkedTo: lastDetIdx, id: i};
                }
                return {t:w, type:'txt', id: i};
            });
            return { p: parsed };
        }

        function startGame(lvl) {
            screenMode = 'game';
            currentLevel = lvl;
            levelQueue = [...rawData[lvl]].sort(() => Math.random() - 0.5).slice(0, 10).map(s => parseSentence(s));
            currentIdx = 0;
            document.getElementById('homeScreen').classList.remove('active');
            homeBubble.classList.add('hidden');
            const gScreen = document.getElementById('gameScreen');
            gScreen.classList.add('active');
            gScreen.className = `screen active level-${lvl}`;
            updateRobotPosition();
            loadQuestion();
        }

        function loadQuestion() {
            const data = levelQueue[currentIdx];
            progress = { dets: [], bridges: [], suffixes: [] };
            document.getElementById('progressText').innerText = `Phrase ${currentIdx+1}/10`;
            const cont = document.getElementById('gameSentence');
            cont.innerHTML = '';
            
            data.p.forEach((p, i) => {
                const span = document.createElement('span');
                span.className = 'word';
                if(p.type === 'det') {
                    span.innerHTML = `<span class="target-zone det" data-idx="${i}">${p.t}</span>`;
                } else if(p.type === 'adj_noun') {
                    let placeholder = (currentLevel === 1) ? "_" : " ";
                    span.innerHTML = `${p.root}<span class="target-zone suffix suffix-zone" data-idx="${i}" data-val="${p.s}">${placeholder}</span>`;
                } else {
                    span.innerText = p.t;
                }
                cont.appendChild(span);
            });
            document.getElementById('nextBtn').classList.add('hidden');
            ctx.clearRect(0,0,drawingCanvas.width, drawingCanvas.height);
            updateInstruction();
        }

        function updateInstruction() {
            const instr = document.getElementById('instruction');
            const data = levelQueue[currentIdx];
            const dets = data.p.filter(p => p.type === 'det');
            const suffixes = data.p.filter(p => p.type === 'adj_noun');
            
            const allDetsDone = progress.dets.length === dets.length;
            const allSuffixesDone = progress.suffixes.length === suffixes.length;

            if(allDetsDone && allSuffixesDone) {
                instr.innerText = "Bravo ! Les accords sont r√©par√©s !";
                document.getElementById('nextBtn').classList.remove('hidden');
                confetti({ particleCount: 100, spread: 70, origin: { y: 0.6 } });
            } else if(!allDetsDone) {
                instr.innerText = "√âtape 1 : Entoure les d√©terminants au pluriel";
            } else {
                instr.innerText = "√âtape 2 : Relie et entoure les marques du pluriel (s ou x)";
            }
        }

        function updateRobotPosition() {
            if(screenMode === 'home') {
                robot.style.top = '25%'; robot.style.left = '75%';
                homeBubble.classList.remove('hidden');
            } else {
                robot.style.top = '8%'; robot.style.left = '5%';
                homeBubble.classList.add('hidden');
            }
        }

        function handleStart(e) {
            if (screenMode !== 'game') return;
            isDrawing = true;
            const x = e.touches ? e.touches[0].clientX : e.clientX;
            const y = e.touches ? e.touches[0].clientY : e.clientY;
            points = [{x, y}];
        }

        function handleMove(e) {
            if(!isDrawing) return;
            const x = e.touches ? e.touches[0].clientX : e.clientX;
            const y = e.touches ? e.touches[0].clientY : e.clientY;
            points.push({x, y});
            redrawAll();
            ctx.strokeStyle = '#94a3b8'; 
            ctx.lineWidth = 2;
            ctx.setLineDash([5, 5]);
            ctx.beginPath();
            ctx.moveTo(points[0].x, points[0].y);
            for(let i=1; i<points.length; i++) ctx.lineTo(points[i].x, points[i].y);
            ctx.stroke();
            ctx.setLineDash([]);
        }

        function handleEnd() {
            if(!isDrawing) return;
            isDrawing = false;
            checkAction();
            redrawAll();
            points = [];
        }

        function checkAction() {
            if(points.length < 5) return;
            const bounds = getPointsBounds(points);
            const mid = { x: (bounds.minX + bounds.maxX)/2, y: (bounds.minY + bounds.maxY)/2 };
            const data = levelQueue[currentIdx];

            const targetDets = Array.from(document.querySelectorAll('.det'));
            const hitDet = targetDets.find(el => isInside(mid, el.getBoundingClientRect()) && !progress.dets.includes(el.dataset.idx));
            if(hitDet) {
                progress.dets.push(hitDet.dataset.idx);
                hitDet.classList.add('success-highlight');
                return updateInstruction();
            }

            const suffixes = Array.from(document.querySelectorAll('.suffix'));
            const hitSuffix = suffixes.find(el => isInside(mid, el.getBoundingClientRect()) && !progress.suffixes.includes(el.dataset.idx));
            if(hitSuffix) {
                const tIdx = parseInt(hitSuffix.dataset.idx);
                const detIdStr = String(data.p[tIdx].linkedTo);
                if(progress.dets.includes(detIdStr)) {
                    progress.suffixes.push(hitSuffix.dataset.idx);
                    hitSuffix.classList.add('revealed');
                    hitSuffix.innerText = hitSuffix.dataset.val;
                    if(!progress.bridges.some(b => b.to === hitSuffix.dataset.idx)) {
                         progress.bridges.push({from: detIdStr, to: hitSuffix.dataset.idx});
                    }
                    return updateInstruction();
                }
            }

            const suffixToBridge = suffixes.find(el => !progress.bridges.some(b => b.to === el.dataset.idx));
            if(suffixToBridge) {
                const tIdx = parseInt(suffixToBridge.dataset.idx);
                const detIdx = data.p[tIdx].linkedTo;
                if(progress.dets.includes(String(detIdx))) {
                    const startEl = document.querySelector(`[data-idx="${detIdx}"]`);
                    const startRect = startEl.getBoundingClientRect();
                    const endRect = suffixToBridge.closest('.word').getBoundingClientRect();
                    const pStart = points[0];
                    const pEnd = points[points.length-1];
                    
                    if( (dist(pStart, startRect) < 120 && dist(pEnd, endRect) < 120) || 
                        (dist(pEnd, startRect) < 120 && dist(pStart, endRect) < 120) ) {
                        progress.bridges.push({from: String(detIdx), to: suffixToBridge.dataset.idx});
                        return updateInstruction();
                    }
                }
            }
        }

        function redrawAll() {
            ctx.clearRect(0,0,drawingCanvas.width, drawingCanvas.height);
            ctx.lineWidth = 5; ctx.strokeStyle = '#16a34a'; ctx.lineCap = 'round'; ctx.lineJoin = 'round';
            
            progress.dets.forEach(idx => {
                const el = document.querySelector(`.det[data-idx="${idx}"]`);
                if(el) {
                    const r = el.getBoundingClientRect();
                    ctx.beginPath();
                    ctx.ellipse(r.left + r.width/2, r.top + r.height/2, (r.width/2) + 15, (r.height/2) + 10, 0, 0, Math.PI*2);
                    ctx.stroke();
                }
            });

            progress.suffixes.forEach(idx => {
                const el = document.querySelector(`.suffix[data-idx="${idx}"]`);
                if(el) {
                    const r = el.getBoundingClientRect();
                    ctx.beginPath();
                    ctx.ellipse(r.left + r.width/2, r.top + r.height/2, 28, 28, 0, 0, Math.PI*2);
                    ctx.stroke();
                }
            });

            progress.bridges.forEach(b => {
                const startEl = document.querySelector(`[data-idx="${b.from}"]`);
                const endEl = document.querySelector(`[data-idx="${b.to}"]`);
                if(!startEl || !endEl) return;
                const start = startEl.getBoundingClientRect();
                const end = endEl.getBoundingClientRect();
                ctx.beginPath();
                ctx.moveTo(start.left + start.width/2, start.top);
                const distH = Math.abs(start.left - end.left) / 2;
                ctx.quadraticCurveTo((start.left + end.left)/2, Math.min(start.top, end.top) - (30 + distH/4), end.left + end.width/2, end.top);
                ctx.stroke();
            });
        }

        function getPointsBounds(pts) {
            let minX=9999, minY=9999, maxX=0, maxY=0;
            pts.forEach(p=>{ minX=Math.min(minX,p.x); minY=Math.min(minY,p.y); maxX=Math.max(maxX,p.x); maxY=Math.max(maxY,p.y); });
            return {minX, minY, maxX, maxY};
        }
        function isInside(p, r) { return p.x > r.left-30 && p.x < r.right+30 && p.y > r.top-30 && p.y < r.bottom+30; }
        function dist(p, r) { const cx=r.left+r.width/2, cy=r.top+r.height/2; return Math.hypot(p.x-cx, p.y-cy); }

        function showModal(id) { 
            document.getElementById(id).style.display = 'flex'; 
            if(id === 'lessonModal') document.getElementById('lessonIframe').src = "https://lesfondamentaux.reseau-canope.fr:/embed/video/accord-en-nombre-determinant-nom-commun-15"; 
        }
        function closeModal(id) { 
            document.getElementById(id).style.display = 'none'; 
            document.getElementById('lessonIframe').src = ""; 
        }
        
        function goHome() { 
            screenMode = 'home'; 
            document.getElementById('gameScreen').classList.remove('active'); 
            document.getElementById('homeScreen').classList.add('active'); 
            updateRobotPosition();
            ctx.clearRect(0,0,drawingCanvas.width, drawingCanvas.height);
        }
        
        function nextQuestion() { 
            currentIdx++; 
            if(currentIdx >= levelQueue.length) {
                confetti({ particleCount: 200, spread: 100, origin: { y: 0.5 } });
                setTimeout(goHome, 2000);
            } else loadQuestion(); 
        }

        window.onload = () => { 
            drawingCanvas.width = window.innerWidth; 
            drawingCanvas.height = window.innerHeight; 
            updateRobotPosition();
        };
        window.onresize = () => { 
            drawingCanvas.width = window.innerWidth; 
            drawingCanvas.height = window.innerHeight; 
            redrawAll();
        };

        drawingCanvas.addEventListener('mousedown', handleStart);
        drawingCanvas.addEventListener('mousemove', handleMove);
        window.addEventListener('mouseup', handleEnd);
        drawingCanvas.addEventListener('touchstart', (e) => { handleStart(e); }, {passive: false});
        drawingCanvas.addEventListener('touchmove', (e) => { if(isDrawing) { e.preventDefault(); handleMove(e); } }, {passive: false});
        window.addEventListener('touchend', handleEnd);
    </script>
</body>
</html>


